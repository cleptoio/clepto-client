# Clepto.io Client Portal - VPS Deployment Guide

## ðŸŽ¯ Overview

The Clepto.io Client Portal is a professional, real-time dashboard for AI automation agency clients to monitor their workflow executions, track AI costs, and manage compliance information.

## ðŸ“‹ Production Information

### URLs
- **Production URL:** https://client.clepto.io
- **Admin Portal:** https://admin.clepto.io (port 3000)
- **Client Portal:** https://client.clepto.io (port 3001)

### VPS Details
- **Host:** srv1003656.hstgr.cloud
- **IP Address:** 82.29.188.163
- **SSH Access:** `ssh root@srv1003656.hstgr.cloud`
- **Port:** 3001 (Admin uses 3000)
- **Process Manager:** PM2
- **Reverse Proxy:** Traefik (ports 80/443 with automatic SSL)

### Test Credentials
- **Email:** test.client@example.com
- **Password:** TestClient@2025
- **Client ID:** 010aa590-54c7-4aa3-bb10-80e5d825f056

---

## ðŸš€ Deployment Steps

### 1. SSH into VPS

```bash
ssh root@srv1003656.hstgr.cloud
```

### 2. Navigate to or Clone Repository

```bash
cd /root
# If not already cloned:
git clone https://github.com/cleptoio/clepto-client.git
cd clepto-client
```

### 3. Pull Latest Changes

```bash
git pull origin main
# Or specific branch:
# git pull origin claude/deploy-client-portal-vps-01X79ART4EZcPKVP5SoYshh2
```

### 4. Create Production Environment File

```bash
cat > .env.production << 'EOF'
NEXT_PUBLIC_SUPABASE_URL=https://ajnffhxkuiygnghnkerb.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqbmZmaHhrdWl5Z25naG5rZXJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MTQ5NDYsImV4cCI6MjA3ODk5MDk0Nn0.em_wZM9zntqpymvlw4TL_r6z18JA5JxsefWhBGOb0f4
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqbmZmaHhrdWl5Z25naG5rZXJiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzQxNDk0NiwiZXhwIjoyMDc4OTkwOTQ2fQ.Gr0EEk4TRw8la1thA4KD3QMjZnqoNzThbZfGGkm1WHc
NODE_ENV=production
EOF
```

### 5. Install Dependencies

```bash
npm install
```

### 6. Build the Application

```bash
npm run build
```

### 7. Start or Restart with PM2

```bash
# If first time deployment:
pm2 start npm --name "clepto-client" -- start

# If updating existing deployment:
pm2 restart clepto-client

# Save PM2 configuration
pm2 save
```

### 8. Configure Traefik Routing (First Time Only)

```bash
# Create Traefik dynamic config for client portal
cat > /etc/traefik/dynamic/client-portal.yml << 'EOF'
http:
  routers:
    client-portal:
      rule: "Host(`client.clepto.io`)"
      service: client-service
      tls:
        certResolver: mytlschallenge
      entryPoints:
        - websecure
        - web

  services:
    client-service:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:3001"
EOF

# Restart Traefik
cd ~
docker-compose restart traefik
```

### 9. Verify Deployment

```bash
# Check PM2 status
pm2 status

# Should show both:
# clepto-admin (port 3000) - online
# clepto-client (port 3001) - online

# Check logs
pm2 logs clepto-client --lines 50

# Test locally
curl http://localhost:3001

# Check Traefik logs
docker logs -f root-traefik-1 | grep client
```

### 10. Verify SSL Certificate

SSL certificates are automatically generated by Let's Encrypt via Traefik. Wait 1-2 minutes for certificate generation, then verify:

```bash
# Visit in browser
https://client.clepto.io

# Should show green padlock in browser
```

---

## ðŸ”§ Useful Commands

### Check Status

```bash
pm2 status
pm2 logs clepto-client
pm2 logs clepto-client --lines 100
pm2 logs clepto-client -f  # Follow logs in real-time
```

### Restart Application

```bash
pm2 restart clepto-client
```

### Stop Application

```bash
pm2 stop clepto-client
```

### Delete Application from PM2

```bash
pm2 delete clepto-client
# Then re-add with: pm2 start npm --name "clepto-client" -- start
```

### Update from GitHub

```bash
cd /root/clepto-client
git pull
npm install
npm run build
pm2 restart clepto-client
```

### Check Both Portals

```bash
pm2 status
curl http://localhost:3000  # Admin portal
curl http://localhost:3001  # Client portal
```

### View Environment

```bash
cd /root/clepto-client
cat .env.production
```

---

## ðŸŽ¨ Features

### Real-Time Monitoring
- **Live Dashboard:** Real-time workflow execution updates using Supabase Realtime
- **Toast Notifications:** Instant alerts when workflows complete
- **Row Level Security (RLS):** Clients only see their own data
- **Client-Filtered Subscriptions:** Real-time updates filtered by client_id

### Core Pages
1. **Dashboard** (`/dashboard`)
   - Welcome message with client name
   - 4 metric cards (Total Executions, Success Rate, Monthly Cost, Avg Duration)
   - 3 interactive charts (Daily Executions, Success Rate Pie, Cost Trend)
   - Recent workflow executions table (last 10)
   - Real-time updates with Live indicator

2. **Executions** (`/executions`)
   - Complete execution history
   - Filters: Status, date range, workflow name
   - Search functionality
   - Execution detail view (`/executions/[id]`)
   - Real-time prepending of new executions

3. **Cost Analytics** (`/costs`)
   - Total AI cost (last 30 days)
   - Daily cost trend chart (14 days)
   - Cost by provider pie chart
   - Top 5 workflows bar chart
   - Detailed cost breakdown tables
   - Real-time cost updates

4. **Compliance** (`/compliance`)
   - Data Processing Agreement (DPA) information
   - Sub-processors list (OpenAI, Anthropic, Google, AWS, Supabase)
   - Privacy & Cookie Policies
   - GDPR/DPDP data rights information
   - Audit log access

5. **Support** (`/support`)
   - Submit support tickets
   - View open and closed tickets
   - Priority levels (Low, Medium, High, Urgent)
   - FAQ section
   - Contact information

6. **Account** (`/account`)
   - Profile information
   - Security settings
   - Session information
   - Last login timestamp

### Design System
- **Color Palette:** Professional light theme
  - Primary: Blue #3b82f6 (Trust, professionalism)
  - Secondary: Cyan #06b6d4 (Modern, tech)
  - Success: Green #10b981
  - Warning: Amber #f59e0b
  - Error: Red #ef4444
  - Accent: Clepto Cyan #00F2EA
- **Typography:** Inter font (body), Orbitron font (logo)
- **UI Components:** shadcn/ui with custom styling
- **Charts:** Recharts library
- **Responsive:** Mobile, tablet, desktop optimized

---

## ðŸ”’ Security

### Row Level Security (RLS)
All Supabase queries and real-time subscriptions are filtered by `client_id`:

```typescript
// Example: Dashboard real-time subscription
const channel = supabase
  .channel(`client-${clientId}-executions`)
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'workflow_executions',
    filter: `client_id=eq.${clientId}` // CRITICAL: Filter by client
  }, handler)
  .subscribe()
```

### Authentication
- **Supabase Auth:** JWT-based authentication
- **Middleware Protection:** All routes protected except /login
- **Session Validation:** Automatic session refresh
- **Client Linking:** Users linked to clients via `user_clients` table

### Data Isolation
- Clients cannot access other clients' data (enforced at database level via RLS policies)
- Real-time subscriptions filtered by client_id
- No sensitive data exposed in client-side JavaScript

---

## ðŸ—„ï¸ Database Schema

### Key Tables
1. **clients** - Client organization information
2. **user_clients** - Links users to their client organizations
3. **workflow_executions** - All workflow execution records (with RLS)
4. **support_tickets** - Support tickets (with RLS)
5. **sub_processors** - Third-party sub-processors list
6. **dpa_signatures** - Data Processing Agreement signatures

### RLS Policies
All tables have Row Level Security policies ensuring:
- Users can only SELECT their own client's data
- Real-time subscriptions respect RLS
- No data leakage between clients

---

## ðŸ§ª Testing

### Local Testing
```bash
npm run dev
# Visit http://localhost:3000
# Login with: test.client@example.com / TestClient@2025
```

### Production Testing
1. Visit https://client.clepto.io
2. Login with test credentials
3. Verify all pages load correctly
4. Test real-time updates (run n8n workflow for test client)
5. Test filters on executions page
6. Submit a test support ticket
7. Check mobile responsiveness

### Security Testing
1. Create another test user with different client_id
2. Login as user A, verify cannot access user B's data
3. Check browser network tab for data leakage
4. Verify RLS policies in Supabase dashboard

---

## ðŸ“Š Tech Stack

- **Framework:** Next.js 16 (App Router)
- **Language:** TypeScript
- **Database:** Supabase (PostgreSQL + Auth + Realtime + RLS)
- **Process Manager:** PM2
- **Reverse Proxy:** Traefik (automatic SSL via Let's Encrypt)
- **UI Components:** shadcn/ui
- **Charts:** Recharts
- **Styling:** Tailwind CSS
- **Date Handling:** date-fns
- **Icons:** Lucide React

---

## ðŸ› Troubleshooting

### Application Not Starting
```bash
# Check PM2 logs
pm2 logs clepto-client --err

# Common issues:
# - Port 3001 already in use
# - Missing .env.production file
# - Build errors (run npm run build and check output)
```

### Real-Time Not Working
```bash
# Check Supabase Realtime is enabled in Supabase dashboard
# Verify client_id is being retrieved correctly
# Check browser console for subscription errors
```

### SSL Certificate Issues
```bash
# Check Traefik logs
docker logs root-traefik-1

# Verify DNS points to VPS IP
dig client.clepto.io

# Restart Traefik
docker-compose restart traefik
```

### Application Crashes
```bash
# Check PM2 status
pm2 status

# View error logs
pm2 logs clepto-client --err

# Restart application
pm2 restart clepto-client

# If persistent, check:
# - Memory usage (pm2 monit)
# - Disk space (df -h)
# - Node version compatibility
```

---

## ðŸ”„ Adding New Clients

1. **Create User in Supabase Auth:**
   - Go to Supabase Dashboard â†’ Authentication â†’ Users
   - Click "Add User"
   - Enter email and password
   - Note the user_id

2. **Create Client Record:**
   ```sql
   INSERT INTO clients (id, name, email, company)
   VALUES ('new-client-uuid', 'Client Name', 'client@example.com', 'Company Inc');
   ```

3. **Link User to Client:**
   ```sql
   INSERT INTO user_clients (user_id, client_id)
   VALUES ('auth-user-id-from-step-1', 'new-client-uuid');
   ```

4. **Send Credentials to Client:**
   - Email: (email from step 1)
   - Password: (password from step 1)
   - Portal URL: https://client.clepto.io

---

## ðŸ“ž Support

- **Developer:** Claude Code (Anthropic)
- **Repository:** https://github.com/cleptoio/clepto-client
- **Issues:** Create a GitHub issue or contact Clepto.io support
- **Email:** support@clepto.io

---

## ðŸ“ Deployment Checklist

- [x] Remove Vercel configuration
- [x] Update package.json for VPS (port 3001)
- [x] Create professional UI with logo and color palette
- [x] Add charts to Dashboard and Costs pages
- [x] Implement real-time Supabase with RLS filtering
- [x] Configure PM2 process manager
- [x] Configure Traefik reverse proxy
- [x] Set up automatic SSL certificates
- [x] Create deployment documentation
- [ ] Deploy to VPS
- [ ] Verify SSL certificate is active
- [ ] Test all features in production
- [ ] Verify RLS and data isolation
- [ ] Test real-time updates
- [ ] Monitor PM2 logs for errors

---

## ðŸŽ‰ Completion Criteria

âœ… **Application Deployed:**
- Running on VPS at https://client.clepto.io
- PM2 process running stably
- SSL certificate active (HTTPS with green padlock)

âœ… **Features Working:**
- Login with test credentials successful
- Dashboard shows real-time data
- All pages functional and professional
- Charts rendering correctly
- Real-time updates appearing when workflows run

âœ… **Security Verified:**
- RLS properly enforced
- Clients only see their own data
- No data leaks verified with multiple test clients
- Real-time subscriptions filtered by client_id

âœ… **Performance:**
- Page load times < 2 seconds
- Real-time updates within 1 second
- No console errors
- Mobile responsive

---

**Last Updated:** November 20, 2025
**Version:** 1.0.0
